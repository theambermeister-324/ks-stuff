<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PCRI Assessment Analytics Dashboard</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg-base: #0f0f1a;
      --bg-card: #1a1a2e;
      --bg-elevated: rgba(255,255,255,0.03);
      --purple-900: #42247f;
      --purple-700: #6436bf;
      --purple-500: #8b5cf6;
      --purple-400: #a78bfa;
      --purple-300: #c4b5fd;
      --green-500: #10b981;
      --green-400: #34d399;
      --blue-500: #3b82f6;
      --blue-400: #60a5fa;
      --amber-500: #f59e0b;
      --amber-400: #fbbf24;
      --red-500: #ef4444;
      --text-primary: #ffffff;
      --text-secondary: rgba(255,255,255,0.85);
      --text-muted: rgba(255,255,255,0.6);
      --border: rgba(100, 54, 191, 0.3);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-base);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }
    
    .dashboard {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--purple-500), var(--purple-700));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      background: linear-gradient(135deg, #fff, var(--purple-300));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--purple-500), var(--purple-700));
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);
    }
    
    .btn-secondary {
      background: var(--bg-elevated);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }
    
    .btn-secondary:hover {
      background: rgba(255,255,255,0.08);
    }
    
    /* Config Panel */
    .config-panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
    }
    
    .config-row {
      display: flex;
      gap: 16px;
      align-items: flex-end;
    }
    
    .config-field {
      flex: 1;
    }
    
    .config-field label {
      display: block;
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    .config-field input {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-base);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.9rem;
    }
    
    .config-field input:focus {
      outline: none;
      border-color: var(--purple-500);
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 32px;
    }
    
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--purple-500), var(--purple-400));
    }
    
    .stat-card.green::before {
      background: linear-gradient(90deg, var(--green-500), var(--green-400));
    }
    
    .stat-card.blue::before {
      background: linear-gradient(90deg, var(--blue-500), var(--blue-400));
    }
    
    .stat-card.amber::before {
      background: linear-gradient(90deg, var(--amber-500), var(--amber-400));
    }
    
    .stat-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 4px;
    }
    
    .stat-change {
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .stat-change.positive { color: var(--green-400); }
    .stat-change.negative { color: var(--red-500); }
    
    /* Charts Grid */
    .charts-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      margin-bottom: 32px;
    }
    
    .chart-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .chart-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .chart-container {
      height: 280px;
      position: relative;
    }
    
    /* Archetype Pills */
    .archetype-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .archetype-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-elevated);
      border-radius: 10px;
    }
    
    .archetype-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    
    .archetype-name {
      flex: 1;
      font-size: 0.9rem;
    }
    
    .archetype-count {
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .archetype-pct {
      font-size: 0.8rem;
      color: var(--text-muted);
      width: 45px;
      text-align: right;
    }
    
    /* Data Table */
    .table-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }
    
    .table-title {
      font-size: 1rem;
      font-weight: 600;
    }
    
    .table-filters {
      display: flex;
      gap: 12px;
    }
    
    .filter-select {
      padding: 8px 12px;
      background: var(--bg-base);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 0.85rem;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th {
      text-align: left;
      padding: 14px 20px;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--bg-elevated);
      border-bottom: 1px solid var(--border);
    }
    
    .data-table td {
      padding: 16px 20px;
      font-size: 0.9rem;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    .data-table tr:hover td {
      background: rgba(139, 92, 246, 0.05);
    }
    
    .score-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 42px;
      height: 28px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.85rem;
    }
    
    .score-badge.high {
      background: rgba(16, 185, 129, 0.2);
      color: var(--green-400);
    }
    
    .score-badge.medium {
      background: rgba(59, 130, 246, 0.2);
      color: var(--blue-400);
    }
    
    .score-badge.low {
      background: rgba(251, 191, 36, 0.2);
      color: var(--amber-400);
    }
    
    .score-badge.critical {
      background: rgba(239, 68, 68, 0.2);
      color: var(--red-500);
    }
    
    .archetype-tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .archetype-tag.transformer {
      background: rgba(16, 185, 129, 0.15);
      color: var(--green-400);
    }
    
    .archetype-tag.optimizer {
      background: rgba(59, 130, 246, 0.15);
      color: var(--blue-400);
    }
    
    .archetype-tag.adopter {
      background: rgba(251, 191, 36, 0.15);
      color: var(--amber-400);
    }
    
    .archetype-tag.builder {
      background: rgba(239, 68, 68, 0.15);
      color: #fca5a5;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 40px;
    }
    
    .empty-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 20px;
      opacity: 0.4;
    }
    
    .empty-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .empty-text {
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    /* Loading State */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--purple-500);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .charts-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .dashboard { padding: 16px; }
      .stats-grid { grid-template-columns: 1fr; }
      header { flex-direction: column; gap: 16px; text-align: center; }
      .config-row { flex-direction: column; }
      .data-table { font-size: 0.8rem; }
      .data-table th, .data-table td { padding: 10px 12px; }
    }
    
    /* Pillar bars */
    .pillar-bars {
      display: flex;
      gap: 8px;
    }
    
    .pillar-bar {
      width: 4px;
      height: 24px;
      border-radius: 2px;
      background: var(--border);
      position: relative;
      overflow: hidden;
    }
    
    .pillar-bar .fill {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      border-radius: 2px;
    }
    
    .pillar-bar.foundation .fill { background: var(--green-400); }
    .pillar-bar.ai .fill { background: var(--purple-400); }
    .pillar-bar.governance .fill { background: var(--blue-400); }
    .pillar-bar.delivery .fill { background: var(--amber-400); }
    .pillar-bar.culture .fill { background: #f472b6; }
  </style>
</head>
<body>
  <div class="dashboard">
    <header>
      <div class="logo">
        <div class="logo-icon">
          <i data-lucide="bar-chart-3" style="width: 22px; height: 22px; color: #fff;"></i>
        </div>
        <div>
          <h1>PCRI Assessment Analytics</h1>
          <p style="font-size: 0.8rem; color: var(--text-muted);">Product Context Readiness Index Dashboard</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="exportData()">
          <i data-lucide="download" style="width: 16px; height: 16px;"></i>
          Export CSV
        </button>
        <button class="btn btn-primary" onclick="refreshData()">
          <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
          Refresh
        </button>
      </div>
    </header>
    
    <!-- Config Panel -->
    <div class="config-panel" id="config-panel">
      <div class="config-row">
        <div class="config-field" style="flex: 3;">
          <label>Google Apps Script URL</label>
          <input type="text" id="api-url" placeholder="https://script.google.com/macros/s/.../exec" />
        </div>
        <button class="btn btn-primary" onclick="connectAndLoad()">
          <i data-lucide="plug" style="width: 16px; height: 16px;"></i>
          Connect
        </button>
      </div>
      <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 12px;">
        Enter your Google Apps Script deployment URL. The URL is saved in your browser for future visits.
      </p>
    </div>
    
    <!-- Stats Grid -->
    <div class="stats-grid" id="stats-grid" style="display: none;">
      <div class="stat-card">
        <div class="stat-label">
          <i data-lucide="users" style="width: 14px; height: 14px;"></i>
          Total Assessments
        </div>
        <div class="stat-value" id="stat-total">—</div>
        <div class="stat-change positive" id="stat-total-change"></div>
      </div>
      
      <div class="stat-card green">
        <div class="stat-label">
          <i data-lucide="trending-up" style="width: 14px; height: 14px;"></i>
          Average PCRI
        </div>
        <div class="stat-value" id="stat-avg-pcri">—</div>
        <div class="stat-change" id="stat-avg-change"></div>
      </div>
      
      <div class="stat-card blue">
        <div class="stat-label">
          <i data-lucide="building-2" style="width: 14px; height: 14px;"></i>
          Organizations
        </div>
        <div class="stat-value" id="stat-orgs">—</div>
      </div>
      
      <div class="stat-card amber">
        <div class="stat-label">
          <i data-lucide="mail" style="width: 14px; height: 14px;"></i>
          Leads Captured
        </div>
        <div class="stat-value" id="stat-leads">—</div>
      </div>
    </div>
    
    <!-- Charts -->
    <div class="charts-grid" id="charts-grid" style="display: none;">
      <div class="chart-card">
        <div class="chart-header">
          <span class="chart-title">PCRI Trend Over Time</span>
          <select class="filter-select" id="trend-filter" onchange="updateTrendChart()">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="all">All time</option>
          </select>
        </div>
        <div class="chart-container">
          <canvas id="trend-chart"></canvas>
        </div>
      </div>
      
      <div class="chart-card">
        <div class="chart-header">
          <span class="chart-title">Archetype Distribution</span>
        </div>
        <div class="archetype-list" id="archetype-list">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>
    
    <!-- Pillar Comparison -->
    <div class="chart-card" id="pillar-chart-card" style="display: none; margin-bottom: 32px;">
      <div class="chart-header">
        <span class="chart-title">Pillar Scores by Industry</span>
        <select class="filter-select" id="industry-filter" onchange="updatePillarChart()">
          <option value="all">All Industries</option>
        </select>
      </div>
      <div class="chart-container">
        <canvas id="pillar-chart"></canvas>
      </div>
    </div>
    
    <!-- Data Table -->
    <div class="table-card" id="table-card" style="display: none;">
      <div class="table-header">
        <span class="table-title">Recent Assessments</span>
        <div class="table-filters">
          <select class="filter-select" id="table-industry-filter" onchange="filterTable()">
            <option value="all">All Industries</option>
          </select>
          <select class="filter-select" id="table-archetype-filter" onchange="filterTable()">
            <option value="all">All Archetypes</option>
            <option value="transformer">Transformer</option>
            <option value="optimizer">Optimizer</option>
            <option value="adopter">Adopter</option>
            <option value="builder">Builder</option>
          </select>
        </div>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Company</th>
            <th>Industry</th>
            <th>PCRI</th>
            <th>Pillars</th>
            <th>Archetype</th>
            <th>Contact</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <!-- Populated by JS -->
        </tbody>
      </table>
    </div>
    
    <!-- Empty State -->
    <div class="empty-state" id="empty-state" style="display: none;">
      <div class="empty-icon">
        <i data-lucide="inbox" style="width: 64px; height: 64px;"></i>
      </div>
      <h3 class="empty-title">No assessments yet</h3>
      <p class="empty-text">Assessments will appear here once users complete the IPE Assessment.</p>
    </div>
    
    <!-- Loading State -->
    <div class="loading" id="loading-state" style="display: none;">
      <div class="spinner"></div>
    </div>
  </div>

  <script>
    // =========================================================================
    // STATE
    // =========================================================================
    let assessments = [];
    let trendChart = null;
    let pillarChart = null;
    
    const archetypeColors = {
      transformer: '#10b981',
      optimizer: '#3b82f6',
      adopter: '#fbbf24',
      builder: '#ef4444'
    };
    
    // =========================================================================
    // INITIALIZATION
    // =========================================================================
    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      
      // Check for saved API URL
      const savedUrl = localStorage.getItem('ipe_dashboard_api_url');
      if (savedUrl) {
        document.getElementById('api-url').value = savedUrl;
        connectAndLoad();
      }
    });
    
    // =========================================================================
    // API FUNCTIONS
    // =========================================================================
    async function connectAndLoad() {
      const url = document.getElementById('api-url').value.trim();
      if (!url) {
        alert('Please enter the Google Apps Script URL');
        return;
      }
      
      // Save URL
      localStorage.setItem('ipe_dashboard_api_url', url);
      
      // Show loading
      showLoading(true);
      
      try {
        const response = await fetch(`${url}?action=export&key=YOUR_SECRET_EXPORT_KEY`);
        const result = await response.json();
        
        if (result.success && result.data) {
          assessments = result.data;
          renderDashboard();
        } else {
          throw new Error(result.error || 'Failed to fetch data');
        }
      } catch (error) {
        console.error('Failed to connect:', error);
        
        // Try demo data for development
        if (confirm('Could not connect to API. Load demo data instead?')) {
          loadDemoData();
        }
      } finally {
        showLoading(false);
      }
    }
    
    function refreshData() {
      connectAndLoad();
    }
    
    // =========================================================================
    // RENDERING
    // =========================================================================
    function renderDashboard() {
      if (assessments.length === 0) {
        showEmpty();
        return;
      }
      
      // Hide config, show dashboard
      document.getElementById('config-panel').style.display = 'none';
      document.getElementById('stats-grid').style.display = 'grid';
      document.getElementById('charts-grid').style.display = 'grid';
      document.getElementById('pillar-chart-card').style.display = 'block';
      document.getElementById('table-card').style.display = 'block';
      document.getElementById('empty-state').style.display = 'none';
      
      renderStats();
      renderArchetypeList();
      renderTrendChart();
      renderPillarChart();
      renderTable();
      populateIndustryFilters();
      
      lucide.createIcons();
    }
    
    function renderStats() {
      const total = assessments.length;
      const avgPcri = Math.round(assessments.reduce((sum, a) => sum + (a['PCRI Score'] || 0), 0) / total);
      const uniqueOrgs = new Set(assessments.map(a => a['Organization ID'] || a['Company'])).size;
      const leads = assessments.filter(a => a['Email']).length;
      
      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-avg-pcri').textContent = avgPcri;
      document.getElementById('stat-orgs').textContent = uniqueOrgs;
      document.getElementById('stat-leads').textContent = leads;
      
      // Calculate trend (last 7 days vs previous 7)
      const now = new Date();
      const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
      const twoWeeksAgo = new Date(now - 14 * 24 * 60 * 60 * 1000);
      
      const thisWeek = assessments.filter(a => new Date(a['Timestamp']) >= weekAgo);
      const lastWeek = assessments.filter(a => {
        const d = new Date(a['Timestamp']);
        return d >= twoWeeksAgo && d < weekAgo;
      });
      
      const change = thisWeek.length - lastWeek.length;
      const changeEl = document.getElementById('stat-total-change');
      if (change > 0) {
        changeEl.className = 'stat-change positive';
        changeEl.innerHTML = `<i data-lucide="trending-up" style="width: 14px; height: 14px;"></i> +${change} this week`;
      } else if (change < 0) {
        changeEl.className = 'stat-change negative';
        changeEl.innerHTML = `<i data-lucide="trending-down" style="width: 14px; height: 14px;"></i> ${change} this week`;
      }
    }
    
    function renderArchetypeList() {
      const counts = { transformer: 0, optimizer: 0, adopter: 0, builder: 0 };
      
      assessments.forEach(a => {
        const key = (a['Archetype Key'] || 'builder').toLowerCase();
        if (counts.hasOwnProperty(key)) {
          counts[key]++;
        }
      });
      
      const total = assessments.length;
      const container = document.getElementById('archetype-list');
      
      container.innerHTML = Object.entries(counts)
        .sort((a, b) => b[1] - a[1])
        .map(([key, count]) => `
          <div class="archetype-item">
            <div class="archetype-dot" style="background: ${archetypeColors[key]}"></div>
            <span class="archetype-name">${key.charAt(0).toUpperCase() + key.slice(1)}</span>
            <span class="archetype-count">${count}</span>
            <span class="archetype-pct">${Math.round(count / total * 100)}%</span>
          </div>
        `).join('');
    }
    
    function renderTrendChart() {
      const ctx = document.getElementById('trend-chart').getContext('2d');
      
      if (trendChart) {
        trendChart.destroy();
      }
      
      // Group by date
      const filter = document.getElementById('trend-filter').value;
      const now = new Date();
      let startDate;
      
      if (filter === 'all') {
        startDate = new Date(Math.min(...assessments.map(a => new Date(a['Timestamp']))));
      } else {
        startDate = new Date(now - parseInt(filter) * 24 * 60 * 60 * 1000);
      }
      
      const filtered = assessments.filter(a => new Date(a['Timestamp']) >= startDate);
      
      // Group by day
      const byDay = {};
      filtered.forEach(a => {
        const day = new Date(a['Timestamp']).toISOString().split('T')[0];
        if (!byDay[day]) {
          byDay[day] = { count: 0, totalPcri: 0 };
        }
        byDay[day].count++;
        byDay[day].totalPcri += a['PCRI Score'] || 0;
      });
      
      const labels = Object.keys(byDay).sort();
      const avgScores = labels.map(day => Math.round(byDay[day].totalPcri / byDay[day].count));
      const counts = labels.map(day => byDay[day].count);
      
      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
          datasets: [
            {
              label: 'Avg PCRI',
              data: avgScores,
              borderColor: '#8b5cf6',
              backgroundColor: 'rgba(139, 92, 246, 0.1)',
              fill: true,
              tension: 0.4,
              yAxisID: 'y'
            },
            {
              label: 'Count',
              data: counts,
              borderColor: '#60a5fa',
              backgroundColor: 'transparent',
              borderDash: [5, 5],
              tension: 0.4,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              labels: { color: 'rgba(255,255,255,0.7)' }
            }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: 'rgba(255,255,255,0.5)' }
            },
            y: {
              type: 'linear',
              position: 'left',
              min: 0,
              max: 100,
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: 'rgba(255,255,255,0.5)' }
            },
            y1: {
              type: 'linear',
              position: 'right',
              grid: { drawOnChartArea: false },
              ticks: { color: 'rgba(255,255,255,0.5)' }
            }
          }
        }
      });
    }
    
    function updateTrendChart() {
      renderTrendChart();
    }
    
    function renderPillarChart() {
      const ctx = document.getElementById('pillar-chart').getContext('2d');
      
      if (pillarChart) {
        pillarChart.destroy();
      }
      
      const industryFilter = document.getElementById('industry-filter').value;
      const filtered = industryFilter === 'all' 
        ? assessments 
        : assessments.filter(a => a['Industry'] === industryFilter);
      
      if (filtered.length === 0) return;
      
      const avgFoundation = Math.round(filtered.reduce((s, a) => s + (a['Foundation (Norm)'] || 0), 0) / filtered.length);
      const avgAI = Math.round(filtered.reduce((s, a) => s + (a['AI Readiness (Norm)'] || 0), 0) / filtered.length);
      const avgGov = Math.round(filtered.reduce((s, a) => s + (a['Governance (Norm)'] || 0), 0) / filtered.length);
      const avgDelivery = Math.round(filtered.reduce((s, a) => s + (a['Delivery (Norm)'] || 0), 0) / filtered.length);
      const avgCulture = Math.round(filtered.reduce((s, a) => s + (a['Culture (Norm)'] || 0), 0) / filtered.length);
      
      pillarChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Culture (25%)', 'Foundation (20%)', 'AI Readiness (20%)', 'Governance (20%)', 'Delivery (15%)'],
          datasets: [{
            label: 'Average Score',
            data: [avgCulture, avgFoundation, avgAI, avgGov, avgDelivery],
            backgroundColor: ['#f472b6', '#34d399', '#a78bfa', '#60a5fa', '#fbbf24'],
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: 'rgba(255,255,255,0.7)' }
            },
            y: {
              min: 0,
              max: 100,
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: 'rgba(255,255,255,0.5)' }
            }
          }
        }
      });
    }
    
    function updatePillarChart() {
      renderPillarChart();
    }
    
    function renderTable() {
      filterTable();
    }
    
    function filterTable() {
      const industryFilter = document.getElementById('table-industry-filter').value;
      const archetypeFilter = document.getElementById('table-archetype-filter').value;
      
      let filtered = [...assessments];
      
      if (industryFilter !== 'all') {
        filtered = filtered.filter(a => a['Industry'] === industryFilter);
      }
      
      if (archetypeFilter !== 'all') {
        filtered = filtered.filter(a => (a['Archetype Key'] || '').toLowerCase() === archetypeFilter);
      }
      
      // Sort by date descending
      filtered.sort((a, b) => new Date(b['Timestamp']) - new Date(a['Timestamp']));
      
      // Take top 50
      filtered = filtered.slice(0, 50);
      
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = filtered.map(a => {
        const pcri = a['PCRI Score'] || 0;
        const scoreClass = pcri >= 75 ? 'high' : pcri >= 50 ? 'medium' : pcri >= 25 ? 'low' : 'critical';
        const archetypeKey = (a['Archetype Key'] || 'builder').toLowerCase();
        const archetypeName = a['Archetype'] || archetypeKey.charAt(0).toUpperCase() + archetypeKey.slice(1);
        
        const foundation = a['Foundation (Norm)'] || 0;
        const ai = a['AI Readiness (Norm)'] || 0;
        const gov = a['Governance (Norm)'] || 0;
        const delivery = a['Delivery (Norm)'] || 0;
        const culture = a['Culture (Norm)'] || 0;
        
        return `
          <tr>
            <td>${new Date(a['Timestamp']).toLocaleDateString()}</td>
            <td>${a['Company'] || a['Organization ID'] || '—'}</td>
            <td>${a['Industry'] || '—'}</td>
            <td><span class="score-badge ${scoreClass}">${pcri}</span></td>
            <td>
              <div class="pillar-bars" title="C:${culture} F:${foundation} A:${ai} G:${gov} D:${delivery}">
                <div class="pillar-bar culture"><div class="fill" style="height: ${culture}%"></div></div>
                <div class="pillar-bar foundation"><div class="fill" style="height: ${foundation}%"></div></div>
                <div class="pillar-bar ai"><div class="fill" style="height: ${ai}%"></div></div>
                <div class="pillar-bar governance"><div class="fill" style="height: ${gov}%"></div></div>
                <div class="pillar-bar delivery"><div class="fill" style="height: ${delivery}%"></div></div>
              </div>
            </td>
            <td><span class="archetype-tag ${archetypeKey}">${archetypeName}</span></td>
            <td>${a['Email'] ? `<a href="mailto:${a['Email']}" style="color: var(--purple-400);">${a['First Name'] || 'Contact'}</a>` : '—'}</td>
          </tr>
        `;
      }).join('');
    }
    
    function populateIndustryFilters() {
      const industries = [...new Set(assessments.map(a => a['Industry']).filter(Boolean))].sort();
      
      const options = industries.map(i => `<option value="${i}">${i}</option>`).join('');
      
      document.getElementById('industry-filter').innerHTML = `<option value="all">All Industries</option>${options}`;
      document.getElementById('table-industry-filter').innerHTML = `<option value="all">All Industries</option>${options}`;
    }
    
    // =========================================================================
    // UTILITIES
    // =========================================================================
    function showLoading(show) {
      document.getElementById('loading-state').style.display = show ? 'flex' : 'none';
      if (show) {
        document.getElementById('stats-grid').style.display = 'none';
        document.getElementById('charts-grid').style.display = 'none';
        document.getElementById('pillar-chart-card').style.display = 'none';
        document.getElementById('table-card').style.display = 'none';
        document.getElementById('empty-state').style.display = 'none';
      }
    }
    
    function showEmpty() {
      document.getElementById('stats-grid').style.display = 'none';
      document.getElementById('charts-grid').style.display = 'none';
      document.getElementById('pillar-chart-card').style.display = 'none';
      document.getElementById('table-card').style.display = 'none';
      document.getElementById('empty-state').style.display = 'block';
      lucide.createIcons();
    }
    
    function exportData() {
      if (assessments.length === 0) {
        alert('No data to export');
        return;
      }
      
      // Convert to CSV
      const headers = Object.keys(assessments[0]);
      const csv = [
        headers.join(','),
        ...assessments.map(row => 
          headers.map(h => {
            const val = row[h] || '';
            // Escape quotes and wrap in quotes if contains comma
            if (typeof val === 'string' && (val.includes(',') || val.includes('"'))) {
              return `"${val.replace(/"/g, '""')}"`;
            }
            return val;
          }).join(',')
        )
      ].join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ipe-assessments-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // =========================================================================
    // DEMO DATA (for testing without backend)
    // =========================================================================
    function loadDemoData() {
      const industries = ['Technology', 'Financial Services', 'Healthcare', 'Retail', 'Manufacturing'];
      const archetypes = ['transformer', 'optimizer', 'adopter', 'builder'];
      const companies = ['Acme Corp', 'TechStart Inc', 'Global Systems', 'InnovateCo', 'DataDriven Ltd', 'CloudFirst', 'AgileWorks', 'DigitalEdge'];
      
      assessments = [];
      
      for (let i = 0; i < 50; i++) {
        const pcri = Math.floor(Math.random() * 70) + 20;
        const archetypeKey = pcri >= 75 ? 'transformer' : pcri >= 55 ? 'optimizer' : pcri >= 35 ? 'adopter' : 'builder';
        const date = new Date(Date.now() - Math.random() * 60 * 24 * 60 * 60 * 1000);
        
        assessments.push({
          'Timestamp': date.toISOString(),
          'Organization ID': `org-${i}`,
          'Industry': industries[Math.floor(Math.random() * industries.length)],
          'PCRI Score': pcri,
          'Foundation (Norm)': Math.floor(Math.random() * 40) + 40,
          'AI Readiness (Norm)': Math.floor(Math.random() * 50) + 20,
          'Governance (Norm)': Math.floor(Math.random() * 45) + 35,
          'Delivery (Norm)': Math.floor(Math.random() * 50) + 30,
          'Culture (Norm)': Math.floor(Math.random() * 45) + 40,
          'Archetype': archetypeKey.charAt(0).toUpperCase() + archetypeKey.slice(1),
          'Archetype Key': archetypeKey,
          'Company': companies[Math.floor(Math.random() * companies.length)],
          'First Name': ['Alex', 'Jordan', 'Morgan', 'Taylor', 'Casey'][Math.floor(Math.random() * 5)],
          'Email': Math.random() > 0.3 ? `user${i}@example.com` : ''
        });
      }
      
      renderDashboard();
    }
  </script>
</body>
</html>

